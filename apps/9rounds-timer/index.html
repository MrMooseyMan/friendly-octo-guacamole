<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Home 9 Rounds</title>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;overflow:hidden}
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:#0a0a0f;
    color:#e0e0e0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    min-height:100dvh;
    -webkit-tap-highlight-color:transparent;
    user-select:none;
  }

  /* --- Workout Select Screen --- */
  #select-screen{
    display:flex;flex-direction:column;align-items:center;
    justify-content:center;gap:20px;width:100%;padding:20px;
    max-height:100vh;max-height:100dvh;overflow-y:auto;
  }
  #select-screen h1{
    font-size:2rem;font-weight:800;letter-spacing:-.02em;
    background:linear-gradient(135deg,#00ff88,#00bbff);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    background-clip:text;
  }
  #select-screen p{color:#888;font-size:.95rem;margin-bottom:10px}
  .workout-btn{
    width:min(90%,360px);padding:18px 24px;border:2px solid #222;
    border-radius:14px;background:#111;color:#fff;font-size:1.1rem;
    font-weight:600;cursor:pointer;transition:all .15s;text-align:left;
  }
  .workout-btn:hover,.workout-btn:active{
    border-color:#00ff88;background:#0a1a10;transform:scale(1.02);
  }
  .workout-btn .day{color:#00ff88;font-size:.8rem;font-weight:700;
    text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px}
  .workout-btn .name{font-size:1.15rem}

  /* --- Timer Screen --- */
  #timer-screen{
    display:none;flex-direction:column;align-items:center;
    justify-content:space-between;width:100%;height:100vh;height:100dvh;
    padding:16px 16px env(safe-area-inset-bottom,16px);
  }

  /* Round lights */
  .round-lights{
    display:flex;gap:8px;padding:8px 0;flex-shrink:0;
  }
  .round-light{
    width:28px;height:28px;border-radius:50%;
    background:#1a1a22;border:2px solid #333;
    transition:all .3s;font-size:.7rem;font-weight:700;
    display:flex;align-items:center;justify-content:center;color:#555;
  }
  .round-light.done{background:#00ff88;border-color:#00ff88;color:#000}
  .round-light.active{
    background:#00ff88;border-color:#00ff88;color:#000;
    box-shadow:0 0 16px #00ff8866;transform:scale(1.15);
  }
  .round-light.active.rest{
    background:#3388ff;border-color:#3388ff;
    box-shadow:0 0 16px #3388ff66;
  }
  .round-light.active.warning{
    background:#ffaa00;border-color:#ffaa00;
    box-shadow:0 0 16px #ffaa0066;
  }

  /* Center content */
  .timer-center{
    flex:1;display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    width:100%;max-width:420px;gap:8px;
  }
  .phase-label{
    font-size:1rem;font-weight:700;text-transform:uppercase;
    letter-spacing:.15em;color:#00ff88;
  }
  .phase-label.rest{color:#3388ff}
  .phase-label.warning{color:#ffaa00}
  .phase-label.countdown{color:#ff4444}

  .timer-display{
    font-size:min(28vw,160px);font-weight:800;
    font-variant-numeric:tabular-nums;line-height:1;
    color:#fff;text-shadow:0 0 40px #00ff8833;
    transition:text-shadow .3s,color .3s;
  }
  .timer-display.rest{text-shadow:0 0 40px #3388ff33}
  .timer-display.warning{color:#ffaa00;text-shadow:0 0 40px #ffaa0044}
  .timer-display.countdown{color:#ff4444;text-shadow:0 0 60px #ff444466;font-size:min(40vw,220px)}

  .station-name{
    font-size:1.4rem;font-weight:700;text-align:center;
    margin-top:8px;color:#fff;padding:0 10px;
  }
  .station-desc{
    font-size:.9rem;color:#aaa;text-align:center;
    line-height:1.4;padding:0 16px;max-height:120px;overflow-y:auto;
  }
  .next-preview{
    font-size:.85rem;color:#667;text-align:center;margin-top:8px;
  }
  .next-preview span{color:#aaa}

  /* Bottom controls */
  .controls{
    display:flex;gap:14px;padding:10px 0;flex-shrink:0;
  }
  .ctrl-btn{
    padding:14px 28px;border:none;border-radius:12px;
    font-size:1rem;font-weight:700;cursor:pointer;
    transition:all .15s;
  }
  .ctrl-btn.primary{background:#00ff88;color:#000}
  .ctrl-btn.primary:active{background:#00dd77;transform:scale(.96)}
  .ctrl-btn.danger{background:#331111;color:#ff4444;border:1px solid #441111}
  .ctrl-btn.danger:active{background:#441111;transform:scale(.96)}
  .ctrl-btn.secondary{background:#1a1a22;color:#aaa;border:1px solid #333}
  .ctrl-btn.secondary:active{background:#222;transform:scale(.96)}

  /* Done screen */
  #done-screen{
    display:none;flex-direction:column;align-items:center;
    justify-content:center;gap:20px;height:100vh;height:100dvh;
  }
  #done-screen h1{font-size:2.2rem;font-weight:800;color:#00ff88}
  #done-screen p{color:#888;font-size:1.1rem}
  #done-screen .time{font-size:1.6rem;color:#fff;font-weight:700}

  /* Countdown overlay */
  #countdown-overlay{
    display:none;position:fixed;inset:0;background:#0a0a0fee;
    z-index:100;align-items:center;justify-content:center;
    flex-direction:column;gap:16px;
  }
  #countdown-overlay .count{
    font-size:min(50vw,280px);font-weight:900;color:#ff4444;
    text-shadow:0 0 80px #ff444466;line-height:1;
  }
  #countdown-overlay .label{
    font-size:1.2rem;color:#888;font-weight:600;text-transform:uppercase;
    letter-spacing:.15em;
  }

  /* Wake lock indicator */
  .wake-lock{
    position:fixed;top:8px;right:12px;font-size:.7rem;
    color:#333;pointer-events:none;
  }

  /* --- Generate Workout --- */
  .divider{
    width:min(90%,360px);display:flex;align-items:center;gap:12px;
    color:#444;font-size:.75rem;text-transform:uppercase;letter-spacing:.12em;
  }
  .divider::before,.divider::after{content:'';flex:1;height:1px;background:#222}

  .generate-btn{
    width:min(90%,360px);padding:18px 24px;border:2px solid #222;
    border-radius:14px;background:linear-gradient(135deg,#111 0%,#0a0f1a 100%);
    color:#fff;font-size:1.1rem;font-weight:600;cursor:pointer;
    transition:all .15s;text-align:left;position:relative;overflow:hidden;
  }
  .generate-btn:hover,.generate-btn:active{
    border-color:#00bbff;background:linear-gradient(135deg,#0a1520 0%,#0a0f1a 100%);
    transform:scale(1.02);
  }
  .generate-btn .day{color:#00bbff;font-size:.8rem;font-weight:700;
    text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px}

  /* Generate modal */
  #generate-modal{
    display:none;position:fixed;inset:0;background:#0a0a0fee;
    z-index:200;align-items:center;justify-content:center;
    flex-direction:column;padding:20px;
  }
  .gen-card{
    background:#111;border:1px solid #222;border-radius:18px;
    padding:28px 24px;width:min(95%,400px);max-height:90vh;
    overflow-y:auto;display:flex;flex-direction:column;gap:20px;
  }
  .gen-card h2{
    font-size:1.4rem;font-weight:800;text-align:center;
    background:linear-gradient(135deg,#00ff88,#00bbff);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    background-clip:text;
  }
  .gen-section{display:flex;flex-direction:column;gap:8px}
  .gen-section label{font-size:.8rem;font-weight:700;color:#888;
    text-transform:uppercase;letter-spacing:.08em}
  .gen-chips{display:flex;flex-wrap:wrap;gap:8px}
  .gen-chip{
    padding:10px 16px;border:2px solid #222;border-radius:10px;
    background:#0a0a0f;color:#aaa;font-size:.9rem;font-weight:600;
    cursor:pointer;transition:all .15s;
  }
  .gen-chip:hover{border-color:#444}
  .gen-chip.selected{border-color:#00ff88;color:#00ff88;background:#0a1a10}
  .gen-chip.selected-blue{border-color:#00bbff;color:#00bbff;background:#0a1020}

  .equip-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .equip-toggle{
    padding:10px 12px;border:2px solid #222;border-radius:10px;
    background:#0a0a0f;color:#666;font-size:.85rem;font-weight:600;
    cursor:pointer;transition:all .15s;text-align:center;
  }
  .equip-toggle:hover{border-color:#444}
  .equip-toggle.on{border-color:#00ff88;color:#00ff88;background:#0a1a10}

  .gen-actions{display:flex;gap:12px}
  .gen-actions .ctrl-btn{flex:1;text-align:center}

  .api-key-row{display:flex;gap:8px}
  .api-key-row input{
    flex:1;padding:10px 14px;border:2px solid #222;border-radius:10px;
    background:#0a0a0f;color:#fff;font-size:.9rem;font-family:inherit;
    outline:none;transition:border-color .15s;
  }
  .api-key-row input:focus{border-color:#00bbff}
  .api-key-row input::placeholder{color:#444}
  .api-key-saved{font-size:.75rem;color:#00ff88;display:none}

  /* Loading state */
  .gen-loading{
    display:none;flex-direction:column;align-items:center;gap:16px;
    padding:20px 0;
  }
  .gen-loading.active{display:flex}
  .gen-spinner{
    width:40px;height:40px;border:3px solid #222;
    border-top-color:#00bbff;border-radius:50%;
    animation:spin .8s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .gen-loading p{color:#888;font-size:.9rem;text-align:center}
  .gen-error{color:#ff4444;font-size:.85rem;text-align:center;display:none}
  .gen-form.hidden{display:none}
</style>
</head>
<body>

<!-- Workout Select -->
<div id="select-screen">
  <h1>Home 9 Rounds</h1>
  <p>Pick your workout</p>
  <button class="workout-btn" onclick="startWorkout(0)">
    <div class="day">Push Day</div>
    <div class="name">Chest, Shoulders, Triceps + Bag</div>
  </button>
  <button class="workout-btn" onclick="startWorkout(1)">
    <div class="day">Pull Day</div>
    <div class="name">Back, Biceps + Bag</div>
  </button>
  <button class="workout-btn" onclick="startWorkout(2)">
    <div class="day">Leg Day</div>
    <div class="name">Legs, Arms + Bag</div>
  </button>
  <button class="workout-btn" onclick="startWorkout(3)">
    <div class="day">Freestyle</div>
    <div class="name">Full Body Brawler</div>
  </button>
  <div class="divider">or</div>
  <button class="generate-btn" onclick="openGenerator()">
    <div class="day">AI Generated</div>
    <div class="name">Build Me a Workout</div>
  </button>
</div>

<!-- Generate Workout Modal -->
<div id="generate-modal">
  <div class="gen-card">
    <h2>Generate Workout</h2>
    <div class="gen-form" id="gen-form">
      <div class="gen-section">
        <label>Focus</label>
        <div class="gen-chips" id="focus-chips">
          <div class="gen-chip selected" data-val="surprise" onclick="selectFocus(this)">Surprise Me</div>
          <div class="gen-chip" data-val="push" onclick="selectFocus(this)">Push</div>
          <div class="gen-chip" data-val="pull" onclick="selectFocus(this)">Pull</div>
          <div class="gen-chip" data-val="legs" onclick="selectFocus(this)">Legs</div>
          <div class="gen-chip" data-val="full" onclick="selectFocus(this)">Full Body</div>
          <div class="gen-chip" data-val="cardio" onclick="selectFocus(this)">Cardio Heavy</div>
        </div>
      </div>
      <div class="gen-section">
        <label>Equipment Available</label>
        <div class="equip-grid" id="equip-grid">
          <div class="equip-toggle on" data-equip="barbell" onclick="toggleEquip(this)">Barbell</div>
          <div class="equip-toggle on" data-equip="bench" onclick="toggleEquip(this)">Bench</div>
          <div class="equip-toggle on" data-equip="rings" onclick="toggleEquip(this)">Rings</div>
          <div class="equip-toggle on" data-equip="pull-up bar" onclick="toggleEquip(this)">Pull-up Bar</div>
          <div class="equip-toggle on" data-equip="heavy bag" onclick="toggleEquip(this)">Heavy Bag</div>
          <div class="equip-toggle on" data-equip="dumbbells" onclick="toggleEquip(this)">Dumbbells</div>
        </div>
      </div>
      <div class="gen-section">
        <label>OpenRouter API Key</label>
        <div class="api-key-row">
          <input type="password" id="api-key-input" placeholder="sk-or-v1-..." autocomplete="off">
        </div>
        <div class="api-key-saved" id="api-key-saved">Key saved</div>
      </div>
      <div class="gen-error" id="gen-error"></div>
      <div class="gen-actions">
        <button class="ctrl-btn secondary" onclick="closeGenerator()">Cancel</button>
        <button class="ctrl-btn primary" onclick="generateWorkout()">Generate</button>
      </div>
    </div>
    <div class="gen-loading" id="gen-loading">
      <div class="gen-spinner"></div>
      <p>Building your workout...</p>
    </div>
  </div>
</div>

<!-- Timer -->
<div id="timer-screen">
  <div class="round-lights" id="round-lights"></div>
  <div class="timer-center">
    <div class="phase-label" id="phase-label">ROUND 1</div>
    <div class="timer-display" id="timer-display">3:00</div>
    <div class="station-name" id="station-name"></div>
    <div class="station-desc" id="station-desc"></div>
    <div class="next-preview" id="next-preview"></div>
  </div>
  <div class="controls">
    <button class="ctrl-btn danger" onclick="quitWorkout()">Quit</button>
    <button class="ctrl-btn secondary" id="skip-btn" onclick="skipPhase()">Skip</button>
    <button class="ctrl-btn primary" id="pause-btn" onclick="togglePause()">Pause</button>
  </div>
</div>

<!-- Countdown Overlay -->
<div id="countdown-overlay">
  <div class="label">Get Ready</div>
  <div class="count" id="countdown-num">3</div>
</div>

<!-- Done Screen -->
<div id="done-screen">
  <h1>Done!</h1>
  <p>Total time</p>
  <div class="time" id="total-time">0:00</div>
  <button class="ctrl-btn primary" onclick="backToSelect()" style="margin-top:20px">Back to Workouts</button>
</div>

<div class="wake-lock" id="wake-lock-status"></div>

<script>
// ============================================================
// WORKOUT DATA
// ============================================================
const WORKOUTS = [
  { // Push Day
    name: "Push Day 9 Rounds",
    rounds: [
      { station: "Warm-up", desc: "High knees 30s, shadow boxing 1 min, arm circles + bodyweight squats 30s, shadow box 1 min. Get loose, get warm." },
      { station: "Barbell Bench Press", desc: "3x10 (Phase 1) / 4x8 (Phase 2+). Rest 60-90 sec between sets." },
      { station: "Bag - Jab/Cross", desc: "1-2 combos, move your feet. Shake out the bench pump. Stay light, find your rhythm." },
      { station: "Overhead Press", desc: "3x8 (Phase 1) / 4x8 (Phase 2+). Strict form, no leg drive." },
      { station: "Bag - Speed Round", desc: "Light, fast punches - high volume. 1-1-2, 1-2-3, 1-2-1-2. Don't load up, just stay busy. Circle the bag." },
      { station: "Ring Push-ups + Ring Dips", desc: "Ring push-ups 3x10, then ring dips 2x8. Superset - push-ups into dips, rest, repeat." },
      { station: "Bag - Power Round", desc: "Controlled hooks and uppercuts. 3-2-3, 5-6-5. Snap and retract at 70-80%. 10 sec burst, 5 sec reset." },
      { station: "Dumbbell Curls", desc: "3x12. Slow negatives. Squeeze at the top. Arms should be screaming." },
      { station: "Core Burnout", desc: "45s plank, 20 bicycle crunches, 15 leg raises, 10 V-ups. Rest 30 sec. Repeat x2." },
    ]
  },
  { // Pull Day
    name: "Pull Day 9 Rounds",
    rounds: [
      { station: "Warm-up", desc: "Shadow boxing 2 min (move your feet, throw light combos), high knees 30s, fast feet 30s." },
      { station: "Pull-ups", desc: "3xAMRAP (Phase 1) / 4xAMRAP (Phase 2+). Rest 90 sec between sets. Use a band if needed." },
      { station: "Bag - 1-2-3 Combos", desc: "Jab-cross-hook. Focus on the hook rotation. Circle the bag between combos." },
      { station: "Barbell Rows", desc: "3x10 (Phase 1) / 4x8 (Phase 2+). Squeeze your shoulder blades at the top." },
      { station: "Bag - Body Shots", desc: "Throw 1-2 up top, then dip and throw 2 body hooks. Practice level changes - head, body, head, body." },
      { station: "Ring Rows", desc: "3x10. Feet elevated if you can. Slow and controlled - 2 sec up, 2 sec down." },
      { station: "Bag - Full Combos", desc: "1-2-3-2, 1-2-5-2, 1-2-3-6-3-2. Let everything fly. Move your feet. Hands UP between combos." },
      { station: "DB Hammer Curls + Ring Hold", desc: "Hammer curls 3x12, then ring support hold 3x20 sec. Arms will be shaking." },
      { station: "Core Burnout", desc: "Hanging knee raises x15, plank 45s, Russian twists x20. Rest 30 sec. Repeat x2." },
    ]
  },
  { // Legs
    name: "Legs + Bag 9 Rounds",
    rounds: [
      { station: "Warm-up", desc: "High knees 30s, butt kicks 30s, lateral hops 30s, bodyweight squats 30s, shadow boxing 1 min." },
      { station: "Barbell Squats", desc: "3x10 (Phase 1) / 4x8 (Phase 2+). Full depth. Control the descent." },
      { station: "Bag - Jab/Cross/Hook", desc: "1-2-3 combos. Legs are heavy from squats - plant your feet and rotate through the hips." },
      { station: "Romanian Deadlifts", desc: "3x8 (Phase 1) / 4x8 (Phase 2+). Slow negative, feel the hamstring stretch." },
      { station: "Bag - Uppercuts + Body", desc: "5-6 uppercut combos with body hooks. Get low, bend knees, drive up through the legs." },
      { station: "Calf Raises + Squat Jumps", desc: "Calf raises 2x15, then squat jumps 2x10. Explosive on the jumps." },
      { station: "Bag - Power Round", desc: "Controlled hooks and uppercuts. 3-2-3, 5-6-5. Snap and retract at 70-80%. Stay composed." },
      { station: "BB Curls + Ring Dips", desc: "3x10 each. Curl, straight to dips, rest, repeat. Arm pump to finish." },
      { station: "Core Burnout", desc: "Barbell rollouts x10 (or ab wheel), side plank 30s/side, flutter kicks 30s. Rest 30 sec. Repeat x2." },
    ]
  },
  { // Freestyle
    name: "Full Body Brawler",
    rounds: [
      { station: "Warm-up", desc: "Shadow boxing 2 min (throw real combos, move around), high knees 30s, fast feet 30s." },
      { station: "Pick a Compound Lift", desc: "Bench, squats, rows, OHP - whatever you feel like. Do 3x8." },
      { station: "Bag - Freestyle", desc: "Whatever you want. Combos, power shots, body work, movement. Just flow." },
      { station: "Pick a Ring Exercise", desc: "Push-ups, dips, rows, support holds - dealer's choice. 3 sets." },
      { station: "Bag - Speed Round", desc: "Light and fast. Nonstop volume punching. 1-2s, 1-1-2s. Don't stop. Cardio round." },
      { station: "Pick an Isolation Lift", desc: "Curls, hammer curls, calf raises, RDLs - whatever's lagging. 3x12." },
      { station: "Bag - War Round", desc: "3 min at 80%. Championship round. Best combos, best footwork, best form. Finish strong." },
      { station: "Pull-ups + Push-ups", desc: "Alternate: pull-up set, push-up set. 3 rounds. No rest between the two." },
      { station: "Core + Stretch", desc: "5 min core circuit (your choice), then 5 min stretching. Cool down. You earned it." },
    ]
  }
];

// ============================================================
// CONFIG
// ============================================================
const WORK_TIME = 180;   // 3 minutes
const REST_TIME = 90;    // 1.5 minutes
const WARN_TIME = 30;    // warning at 30 sec remaining
const TOTAL_ROUNDS = 9;

// ============================================================
// STATE
// ============================================================
let currentWorkout = null;
let currentRound = 0;     // 0-indexed
let phase = 'work';       // 'work' | 'rest'
let timeLeft = 0;
let running = false;
let paused = false;
let interval = null;
let workoutStartTime = 0;
let wakeLock = null;

// ============================================================
// AUDIO (Web Audio API - zero dependencies)
// ============================================================
let audioCtx = null;

function getAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function playBeep(freq, duration, count, gap) {
  const ctx = getAudio();
  for (let i = 0; i < count; i++) {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = freq;
    osc.type = 'square';
    const start = ctx.currentTime + i * (duration + gap);
    gain.gain.setValueAtTime(0.3, start);
    gain.gain.exponentialRampToValueAtTime(0.001, start + duration);
    osc.start(start);
    osc.stop(start + duration);
  }
}

function playBell() {
  const ctx = getAudio();
  // Metallic bell - layered frequencies
  const freqs = [800, 1200, 1600, 2400];
  freqs.forEach((f, i) => {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = f;
    osc.type = 'sine';
    const vol = 0.15 / (i + 1);
    const t = ctx.currentTime;
    gain.gain.setValueAtTime(vol, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 1.2);
    osc.start(t);
    osc.stop(t + 1.3);
  });
  // Impact noise
  const buf = ctx.createBuffer(1, ctx.sampleRate * 0.05, ctx.sampleRate);
  const data = buf.getChannelData(0);
  for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * (1 - i / data.length);
  const noise = ctx.createBufferSource();
  noise.buffer = buf;
  const ng = ctx.createGain();
  noise.connect(ng);
  ng.connect(ctx.destination);
  ng.gain.setValueAtTime(0.4, ctx.currentTime);
  ng.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
  noise.start(ctx.currentTime);
}

function playWarningBeeps() { playBeep(880, 0.15, 2, 0.12); }

function playTripleBell() {
  playBell();
  setTimeout(playBell, 500);
  setTimeout(playBell, 1000);
}

// ============================================================
// WAKE LOCK
// ============================================================
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      document.getElementById('wake-lock-status').textContent = '';
    }
  } catch (e) { /* not critical */ }
}

function releaseWakeLock() {
  if (wakeLock) { wakeLock.release(); wakeLock = null; }
}

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && running && !paused) requestWakeLock();
});

// ============================================================
// UI HELPERS
// ============================================================
function $(id) { return document.getElementById(id); }

function show(id) { $(id).style.display = 'flex'; }
function hide(id) { $(id).style.display = 'none'; }

function formatTime(secs) {
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  return m + ':' + String(s).padStart(2, '0');
}

function buildRoundLights() {
  const container = $('round-lights');
  container.innerHTML = '';
  for (let i = 0; i < TOTAL_ROUNDS; i++) {
    const el = document.createElement('div');
    el.className = 'round-light';
    el.textContent = i + 1;
    el.id = 'light-' + i;
    container.appendChild(el);
  }
}

function updateRoundLights() {
  for (let i = 0; i < TOTAL_ROUNDS; i++) {
    const el = $('light-' + i);
    el.className = 'round-light';
    if (i < currentRound) {
      el.classList.add('done');
    } else if (i === currentRound) {
      el.classList.add('active');
      if (phase === 'rest') el.classList.add('rest');
      else if (timeLeft <= WARN_TIME && timeLeft > 0) el.classList.add('warning');
    }
  }
}

function updateTimerUI() {
  const display = $('timer-display');
  const label = $('phase-label');
  const sName = $('station-name');
  const sDesc = $('station-desc');
  const preview = $('next-preview');

  display.textContent = formatTime(timeLeft);
  display.className = 'timer-display';
  label.className = 'phase-label';

  if (phase === 'work') {
    const round = currentWorkout.rounds[currentRound];
    label.textContent = 'Round ' + (currentRound + 1);
    sName.textContent = round.station;
    sDesc.textContent = round.desc;

    if (timeLeft <= WARN_TIME && timeLeft > 0) {
      display.classList.add('warning');
      label.classList.add('warning');
    }

    if (currentRound < TOTAL_ROUNDS - 1) {
      preview.innerHTML = 'Next: <span>' + currentWorkout.rounds[currentRound + 1].station + '</span>';
    } else {
      preview.textContent = 'Final round!';
    }
  } else {
    label.textContent = 'REST';
    label.classList.add('rest');
    display.classList.add('rest');
    sName.textContent = '';
    sDesc.textContent = 'Shake it out. Grab water.';
    if (currentRound < TOTAL_ROUNDS) {
      preview.innerHTML = 'Up next: <span>Round ' + (currentRound + 1) + ' \u2014 ' + currentWorkout.rounds[currentRound].station + '</span>';
    }
  }

  updateRoundLights();
}

// ============================================================
// TIMER LOGIC
// ============================================================
function tick() {
  if (paused) return;
  timeLeft--;

  if (phase === 'work' && timeLeft === WARN_TIME) {
    playWarningBeeps();
  }

  if (timeLeft <= 0) {
    playBell();
    if (phase === 'work') {
      currentRound++;
      if (currentRound >= TOTAL_ROUNDS) {
        finishWorkout();
        return;
      }
      phase = 'rest';
      timeLeft = REST_TIME;
    } else {
      phase = 'work';
      timeLeft = WORK_TIME;
      playBell();
    }
  }

  updateTimerUI();
}

function startTimer() {
  if (interval) clearInterval(interval);
  interval = setInterval(tick, 1000);
  running = true;
}

function togglePause() {
  paused = !paused;
  $('pause-btn').textContent = paused ? 'Resume' : 'Pause';
  $('pause-btn').className = paused ? 'ctrl-btn primary' : 'ctrl-btn primary';
}

function skipPhase() {
  if (phase === 'work') {
    currentRound++;
    if (currentRound >= TOTAL_ROUNDS) {
      finishWorkout();
      return;
    }
    phase = 'rest';
    timeLeft = REST_TIME;
  } else {
    phase = 'work';
    timeLeft = WORK_TIME;
  }
  playBell();
  updateTimerUI();
}

// ============================================================
// WORKOUT FLOW
// ============================================================
function startWorkout(idx) {
  // Init audio on user gesture
  getAudio();

  currentWorkout = WORKOUTS[idx];
  currentRound = 0;
  phase = 'work';
  timeLeft = WORK_TIME;
  paused = false;
  $('pause-btn').textContent = 'Pause';

  hide('select-screen');
  hide('done-screen');
  show('timer-screen');
  buildRoundLights();

  requestWakeLock();
  workoutStartTime = Date.now();

  // 3-2-1 countdown
  show('countdown-overlay');
  let count = 3;
  $('countdown-num').textContent = count;
  playBeep(600, 0.1, 1, 0);

  const cdInterval = setInterval(() => {
    count--;
    if (count > 0) {
      $('countdown-num').textContent = count;
      playBeep(600, 0.1, 1, 0);
    } else {
      clearInterval(cdInterval);
      hide('countdown-overlay');
      playBell();
      updateTimerUI();
      startTimer();
    }
  }, 1000);
}

function finishWorkout() {
  clearInterval(interval);
  interval = null;
  running = false;
  releaseWakeLock();

  const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
  hide('timer-screen');
  show('done-screen');
  $('total-time').textContent = formatTime(elapsed);

  playTripleBell();
}

function quitWorkout() {
  clearInterval(interval);
  interval = null;
  running = false;
  paused = false;
  releaseWakeLock();
  hide('timer-screen');
  hide('countdown-overlay');
  show('select-screen');
}

function backToSelect() {
  hide('done-screen');
  show('select-screen');
}

// ============================================================
// WORKOUT GENERATOR (OpenRouter)
// ============================================================
const GEN_MODEL = 'google/gemini-2.0-flash-001';
let selectedFocus = 'surprise';

function openGenerator() {
  const saved = localStorage.getItem('openrouter_key');
  if (saved) {
    $('api-key-input').value = saved;
    $('api-key-saved').style.display = 'block';
  }
  $('gen-error').style.display = 'none';
  $('gen-form').classList.remove('hidden');
  $('gen-loading').classList.remove('active');
  show('generate-modal');
}

function closeGenerator() {
  hide('generate-modal');
}

function selectFocus(el) {
  document.querySelectorAll('#focus-chips .gen-chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedFocus = el.dataset.val;
}

function toggleEquip(el) {
  el.classList.toggle('on');
}

function getSelectedEquipment() {
  return Array.from(document.querySelectorAll('#equip-grid .equip-toggle.on'))
    .map(el => el.dataset.equip);
}

async function generateWorkout() {
  const apiKey = $('api-key-input').value.trim();
  if (!apiKey) {
    $('gen-error').textContent = 'Enter your OpenRouter API key';
    $('gen-error').style.display = 'block';
    return;
  }
  localStorage.setItem('openrouter_key', apiKey);
  $('api-key-saved').style.display = 'block';

  const equipment = getSelectedEquipment();
  if (equipment.length === 0) {
    $('gen-error').textContent = 'Select at least one piece of equipment';
    $('gen-error').style.display = 'block';
    return;
  }

  $('gen-error').style.display = 'none';
  $('gen-form').classList.add('hidden');
  $('gen-loading').classList.add('active');

  const focusMap = {
    surprise: 'a random focus of your choice (push, pull, legs, full body, or something creative)',
    push: 'push muscles (chest, shoulders, triceps)',
    pull: 'pull muscles (back, biceps)',
    legs: 'legs and lower body',
    full: 'full body',
    cardio: 'cardio-heavy with minimal rest, high intensity',
  };

  const prompt = `You are a workout program designer for a home gym hybrid boxing + lifting program.

The user has this equipment: ${equipment.join(', ')}.
${equipment.includes('heavy bag') ? 'Heavy bag rounds should be mixed in between lifting rounds as active recovery/cardio.' : ''}

Generate a 9-round workout focused on: ${focusMap[selectedFocus]}.

Rules:
- Exactly 9 rounds. Each round is 3 minutes of work followed by 90 sec rest.
- Round 1 is always a warm-up.
- Round 9 is always a core/cooldown finisher.
- ${equipment.includes('heavy bag') ? 'Alternate lifting rounds and bag rounds (rounds 2-8). Bag rounds should include specific boxing combos using numbers (1=jab, 2=cross, 3=lead hook, 4=rear hook, 5=lead uppercut, 6=rear uppercut).' : 'Fill all 9 rounds with exercises using the available equipment.'}
- Each round needs a short station name (2-5 words) and a detailed description with specific sets, reps, and coaching cues.
- Be creative - don't repeat the same exercises every time. Mix it up.
- Write in a motivating, direct, no-BS coaching voice.

Respond with ONLY valid JSON, no markdown, no code fences. Use this exact format:
{
  "name": "Workout Name Here",
  "rounds": [
    {"station": "Station Name", "desc": "Detailed description with sets, reps, and cues."},
    ... (9 total)
  ]
}`;

  try {
    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + apiKey,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: GEN_MODEL,
        messages: [{ role: 'user', content: prompt }],
        temperature: 1.0,
        max_tokens: 2000,
      }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error?.message || 'API error ' + res.status);
    }

    const data = await res.json();
    const content = data.choices?.[0]?.message?.content;
    if (!content) throw new Error('Empty response from API');

    // Parse JSON - strip markdown fences if model adds them
    const cleaned = content.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
    const workout = JSON.parse(cleaned);

    if (!workout.rounds || workout.rounds.length !== 9) {
      throw new Error('Invalid workout format (expected 9 rounds, got ' + (workout.rounds?.length || 0) + ')');
    }

    // Launch it
    hide('generate-modal');
    currentWorkout = workout;
    currentRound = 0;
    phase = 'work';
    timeLeft = WORK_TIME;
    paused = false;
    $('pause-btn').textContent = 'Pause';

    hide('select-screen');
    hide('done-screen');
    show('timer-screen');
    buildRoundLights();
    requestWakeLock();
    workoutStartTime = Date.now();

    // Init audio on user gesture
    getAudio();

    // 3-2-1 countdown
    show('countdown-overlay');
    let count = 3;
    $('countdown-num').textContent = count;
    playBeep(600, 0.1, 1, 0);
    const cdInterval = setInterval(() => {
      count--;
      if (count > 0) {
        $('countdown-num').textContent = count;
        playBeep(600, 0.1, 1, 0);
      } else {
        clearInterval(cdInterval);
        hide('countdown-overlay');
        playBell();
        updateTimerUI();
        startTimer();
      }
    }, 1000);

  } catch (e) {
    $('gen-loading').classList.remove('active');
    $('gen-form').classList.remove('hidden');
    $('gen-error').textContent = e.message || 'Something went wrong';
    $('gen-error').style.display = 'block';
  }
}
</script>
</body>
</html>
